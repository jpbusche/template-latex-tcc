\begin{anexosenv}

\partanexos

\chapter{Código dos \textit{plugins} e do Elasticsearch}
\label{anexo:codes}
\begin{lstlisting}[language={Python}, caption = {Código do \textit{plugin} \textit{\textbf{Steam Currency}}}] [H]
from ext.extractor import Extractor, GameNotFound
import json

class Currency(Extractor):

	url = 'https://api.steampowered.com/ISteamUserStats/GetNumberOfCurrentPlayers/v1/?appid={}'	

	def get_game(self, identifier):
		response = self.get_api(identifier)
		data = response['response']
		if data['result'] == 1:
			result = {}
			result['currency'] = self.temporal_data(identifier, data['player_count'], 'currency')
			return result
		else:
			raise GameNotFound("Game not found!!!")
\end{lstlisting}
\begin{lstlisting}[language={Python}, caption = {Código do \textit{plugin} \textit{\textbf{Steam Store API}}}] [H]
from ext.extractor import Extractor, GameNotFound

class SteamAPI(Extractor):

	url = 'https://store.steampowered.com/api/appdetails/?appids={}'

	def get_game(self, identifier):
		response = self.get_api(identifier)
		data = response[str(identifier)]
		if data['success'] and data is not None:
			result = self.manipulate_data(data['data'], identifier)
			return result
		else:
			raise GameNotFound("Game not found!!!")

	def manipulate_data(self, data, identifier):
		result = {}
		result['genres'] = []
		result['publishers'] = []
		result['developers'] = []
		result['platforms'] = []
		result['screenshots'] = []
		result['name'] = data['name']
		result['steam_id'] = data['steam_appid']
		if data['is_free'] or not 'price_overview' in data:
			result['price'] = self.temporal_data(identifier, 0.0, 'price')
			result['is_free'] = True
		else:
			result['price'] = self.temporal_data(identifier, data['price_overview']['initial'] / 100, 'price')
			result['is_free'] = False
		result['description'] = data['about_the_game']
		result['header_image'] = data['header_image']
		result['background_image'] = data['background']
		if data['website'] is not None:
			result['website'] = data['website']
		else:
			result['website'] = ""
		if 'genres' in data:
			for gnr in data['genres']:
				result['genres'].append(gnr['description'])
		for pbl in data['publishers']:
			result['publishers'].append(pbl)
		if 'developers' in data:
			for dvp in data['developers']:
				result['developers'].append(dvp)
		for plt in data['platforms']:
			if plt: result['platforms'].append(str(plt).capitalize())
		if data['release_date']['date'] != "":
			result['release_date'] = data['release_date']['date']
		else:
			result['release_date'] = '12 Set, 2003'
		if 'metacritic' in data:
			result['metacritic_score'] = data['metacritic']['score']
		else:
			result['metacritic_score'] = 0
		for screen in data['screenshots']:
			result['screenshots'].append(screen['path_full']
\end{lstlisting}
\begin{lstlisting}[language={Python}, caption = {Código do \textit{plugin} \textit{\textbf{Steam Spy API}}}] [H]
from ext.extractor import Extractor, GameNotFound

class SteamSpy(Extractor):
	
	url = 'http://steamspy.com/api.php?request=appdetails&appid={}'

	def get_game(self, identifier):
		response = self.get_api(identifier)
		if response['name'] is not None:
			result = self.manipulate_data(response)
			return result
		else:
			raise GameNotFound("Game not found!!!")

	def manipulate_data(self, data):
		result = {}
		result['languages'] = []
		result['categories'] = []
		result['positive_avaliantion'] = data['positive']
		result['negative_avaliantion'] = data['negative']
		total = data['positive'] + data['negative']
		score = data['positive'] / total * 100
		result['userscore'] = self.temporal_data(identifier, round(score, 2), 'userscore')
		result['median_hours_played'] = self.temporal_data(identifier, data['median_forever'] // 60, 'median_hours_played')
		numbers = data['owners'].split(' .. ')
		own = (int(numbers[0].replace(',', '')) + int(numbers[1].replace(',', ''))) // 2
		result['owners'] = self.temporal_data(identifier, own, 'owners')
		for lng in data['languages'].split(', '):
			result['languages'].append(lng)
		for ctg in data['tags']:
			result['categories'].append(ctg)
		return result
\end{lstlisting}
\begin{lstlisting}[language={Python}, caption = {Código do \textit{plugin} \textit{\textbf{Youtube API}}}] [H]
from ext.extractor import Extractor, GameNotFound, PageNotFound
import requests
import json

class YoutubeAPI(Extractor):

	API_KEY = 'AIzaSyD7uEK8S8NE79iHUx70rTvwXBCEHp5BosQ'

	def get_game(self, identifier):
		videos = self.get_videos(identifier)
		if len(videos) != 0:
			result = self.manipulate_data(videos)
			return result
		else:
			raise GameNotFound("Game not found!!!")


	def get_videos(self, identifier):	
		videos_id = []
		url = 'https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q={}&type=video&key={}&order=relevance'
		response = self.get_api(url, identifier)
		for vid in response['items']:
			videos_id.append(vid['id']['videoId'])
		return videos_id

	def get_api(self, url, identifier):
		response = requests.get(url.format(identifier, self.API_KEY))
		if response.status_code == requests.codes.ok:
			response = json.loads(response.text)
			return response
		else:
			raise PageNotFound("Page not found!!!")

	def manipulate_data(self, data):
		result = {}
		url = 'https://www.googleapis.com/youtube/v3/videos?part=statistics&id={}&key={}'
		sum_view = 0
		sum_like = 0
		sum_dislike = 0
		for vid in data:
			response = self.get_api(url, vid)['items'][0]['statistics']
			if 'viewCount' in response: sum_view += int(response['viewCount'])
			if 'likeCount' in response: sum_like += int(response['likeCount'])
			if 'dislikeCount' in response: sum_dislike += int(response['dislikeCount'])
		result['view_count'] = self.temporal_data(identifier, sum_view, 'view_count')
		result['like_count'] = self.temporal_data(identifier, sum_like, 'like_count')
		result['dislike_count'] = self.temporal_data(identifier, sum_dislike, 'dislike_count')
		return result
\end{lstlisting}
\begin{lstlisting}[language={Python}, caption = {Código do \textit{\textbf{Elasticsearch}}}] [H]
import requests
import json
from elasticsearch import Elasticsearch
from db.database import Database, DataNotFound

class Elastic(Database):

	def __init__(self, host, index):
		self.hostname = host
		self.index_name = index
		try:
			self.elastic = self.connect_elasticsearch()
		except ElasticNotConnected as enc:
			raise ElasticNotConnected('Elasticsearch couldn\'t be connected!!!')

	def get(self, identifier):
		res = self.elastic.search(index=self.index_name, body={"query": {"match": {"steam_id": int(identifier)}}})
		if res['hits']['total'] == 1:
			data = res['hits']['hits'][0]['_source']
			return data
		else:
			raise DataNotFound('Data has not found in the Database!!!')

	def update(self, identifier, data):
		if self.has_data(identifier):
			body = {}
			body['doc'] = data
			self.elastic.update(index=self.index_name, doc_type='game', id=identifier, body=body)
		else:
			self.elastic.index(index=self.index_name, doc_type='game', id=identifier, body=data)

	def delete(self, identifier):
		url = 'http://{}/{}/game/{}'
		response = requests.delete(url.format(self.hostname, self.index_name, identifier))
		if response.status_code != requests.codes.ok:
			raise DataNotFound('Data has not found in the Database!!!')

	def has_data(self, identifier):
		url = 'http://{}/{}/game/{}'
		response = requests.get(url.format(self.hostname, self.index_name, identifier))
		if response.status_code == requests.codes.ok:
			return True
		else:
			return False
	
	def connect_elasticsearch(self):
		elastic = Elasticsearch([self.hostname])
		if elastic.ping():
			return elastic
		else:
			raise ElasticNotConnected('Elasticsearch couldn\'t be connected!!!')

	def delete_index(self):
		self.elastic.indices.delete(index=self.index_name, ignore=[400, 404])

	def get_all(self):
		res = self.elastic.search(index=self.index_name, body={"query": {"match_all":{}}})
		size = res['hits']['total']
		res = self.elastic.search(index=self.index_name, body={"size": size, "query": {"match_all":{}}})
		games = []
		for game in res['hits']['hits']:
			pair = (int(game['_id']), game['_source']['name'])
			games.append(pair)
		return games

	def create_index(self, index_body):
		if self.elastic.indices.exists(self.index_name): self.delete_index()
		self.elastic.indices.create(index=self.index_name, body=index_body, ignore=400)


class ElasticNotConnected(Exception):
	pass
\end{lstlisting}

\end{anexosenv}

